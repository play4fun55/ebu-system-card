<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EBU System Card – Page 1 Builder V0.6.0 (DEBUG PDF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 20px 24px 24px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 18px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }
    h3 {
      font-size: 1rem;
      margin-top: 14px;
      margin-bottom: 6px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px 24px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px 16px;
    }
    .field {
      display: flex;
      flex-direction: column;
      margin-top: 8px;
    }
    label {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.92rem;
    }
    input, textarea {
      font: inherit;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
      margin-top: 2px;
    }
    .actions {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font: inherit;
      cursor: pointer;
      background: #1e88e5;
      color: white;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
      box-shadow: none;
    }
    button.danger {
      background: #e53935;
      color: #fff;
      box-shadow: none;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .status {
      font-size: 0.85rem;
      color: #388e3c;
      min-height: 1.2em;
    }
    @media (max-width: 800px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>EBU System Card – Page 1 Builder V0.6.0 (DEBUG PDF)</h1>

    <!-- HEADER -->
    <h2>Header</h2>
    <div class="grid-2">
      <div class="field">
        <label for="playerName">Your name</label>
        <input id="playerName" type="text" placeholder="Your full name" />
      </div>
      <div class="field">
        <label for="playerNumber">Your EBU number</label>
        <input id="playerNumber" type="text" placeholder="e.g. 491316" />
      </div>
      <div class="field">
        <label for="partnerName">Partner's name</label>
        <input id="partnerName" type="text" placeholder="Partner's full name" />
      </div>
      <div class="field">
        <label for="partnerNumber">Partner's EBU number</label>
        <input id="partnerNumber" type="text" placeholder="e.g. 525143" />
      </div>
    </div>

    <div class="field">
      <label for="biddingDescription">General description of bidding methods</label>
      <textarea id="biddingDescription" placeholder="e.g. 2 over 1 GF, 5M, 15–17 NT"></textarea>
    </div>

    <!-- 1NT OPENINGS -->
    <h2>1NT Openings and Responses</h2>

    <div class="grid-2">
      <div class="field">
        <label for="ntStrength">1NT strength</label>
        <input id="ntStrength" type="text" placeholder="e.g. 15–17" />
      </div>
      <div class="field">
        <label for="ntStrengthArtificial">If artificial – details</label>
        <textarea id="ntStrengthArtificial"></textarea>
      </div>

      <div class="field">
        <label for="ntShape">Shape constraints</label>
        <textarea id="ntShape" placeholder="e.g. No singleton or void. No 6-card major or 7-card minor"></textarea>
      </div>
      <div class="field">
        <label for="ntShapeArtificial">If may have singleton – details</label>
        <textarea id="ntShapeArtificial" placeholder="e.g. May contain singleton Ace or King"></textarea>
      </div>
    </div>

    <h3>Responses to 1NT</h3>
    <div class="grid-2">
      <div class="field">
        <label for="nt2c">2♣ – meaning</label>
        <textarea id="nt2c" placeholder="Stayman, may be weak, may take to minor"></textarea>
      </div>
      <div class="field">
        <label for="nt2d">2♦ – meaning</label>
        <textarea id="nt2d" placeholder="Transfer to ♥ (break xx)"></textarea>
      </div>
      <div class="field">
        <label for="nt2h">2♥ – meaning</label>
        <textarea id="nt2h" placeholder="Transfer to ♠ (break xx)"></textarea>
      </div>
      <div class="field">
        <label for="nt2s">2♠ – meaning</label>
        <textarea id="nt2s" placeholder="Minor-suit Stayman: 2NT = 3–3, 3♣/3♦ = longer minor"></textarea>
      </div>
      <div class="field">
        <label for="nt2nt">2NT – meaning</label>
        <textarea id="nt2nt" placeholder="Transfer to ♣"></textarea>
      </div>
      <div class="field">
        <label for="ntOthers">Other 1NT responses</label>
        <textarea id="ntOthers" placeholder="e.g. 3♣ – transfer to ♦; 3♦ = 4-4-4-1 with a major; etc."></textarea>
      </div>
    </div>

    <div class="grid-2">
      <div class="field">
        <label for="afterDouble">Action after opponents double</label>
        <textarea id="afterDouble" placeholder="e.g. Redouble = to play; all two-level bids are transfers (escape system)"></textarea>
      </div>
      <div class="field">
        <label for="afterInterference">Action after other interference</label>
        <textarea id="afterInterference" placeholder="e.g. Lebensohl; double shows values; etc."></textarea>
      </div>
    </div>

    <!-- TWO-LEVEL OPENINGS -->
    <h2>Two-level openings and responses</h2>

    <div class="field small">“Notes” column on final layout shows a note number; the actual text appears on page 4.</div>

    <h3>2♣</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoCMeaning">Meaning</label>
        <textarea id="twoCMeaning" placeholder="Meaning of 2C"></textarea>
      </div>
      <div class="field">
        <label for="twoCResponses">Responses</label>
        <textarea id="twoCResponses" placeholder="Responses to 2C"></textarea>
      </div>
      <div class="field">
        <label for="twoCNotes">Note text (note 1)</label>
        <textarea id="twoCNotes"></textarea>
      </div>
    </div>

    <h3>2♦</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoDMeaning">Meaning</label>
        <textarea id="twoDMeaning" placeholder="Meaning of 2D"></textarea>
      </div>
      <div class="field">
        <label for="twoDResponses">Responses</label>
        <textarea id="twoDResponses" placeholder="Responses to 2D"></textarea>
      </div>
      <div class="field">
        <label for="twoDNotes">Note text (note 2)</label>
        <textarea id="twoDNotes"></textarea>
      </div>
    </div>

    <h3>2♥</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoHMeaning">Meaning</label>
        <textarea id="twoHMeaning" placeholder="Meaning of 2H"></textarea>
      </div>
      <div class="field">
        <label for="twoHResponses">Responses</label>
        <textarea id="twoHResponses" placeholder="Responses to 2H"></textarea>
      </div>
      <div class="field">
        <label for="twoHNotes">Note text (note 3)</label>
        <textarea id="twoHNotes"></textarea>
      </div>
    </div>

    <h3>2♠</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoSMeaning">Meaning</label>
        <textarea id="twoSMeaning" placeholder="Meaning of 2S"></textarea>
      </div>
      <div class="field">
        <label for="twoSResponses">Responses</label>
        <textarea id="twoSResponses" placeholder="Responses to 2S"></textarea>
      </div>
      <div class="field">
        <label for="twoSNotes">Note text (note 4)</label>
        <textarea id="twoSNotes"></textarea>
      </div>
    </div>

    <h3>2NT</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoNTMeaning">Meaning</label>
        <textarea id="twoNTMeaning" placeholder="Meaning of 2NT"></textarea>
      </div>
      <div class="field">
        <label for="twoNTResponses">Responses</label>
        <textarea id="twoNTResponses" placeholder="Responses to 2NT"></textarea>
      </div>
      <div class="field">
        <label for="twoNTNotes">Note text (note 5)</label>
        <textarea id="twoNTNotes"></textarea>
      </div>
    </div>

    <!-- OTHER ASPECTS -->
    <h2>Other aspects of system which opponents should note</h2>
    <div class="field">
      <textarea id="otherAspects" placeholder="Cue-bids, unusual 2NT, defensive conventions, etc."></textarea>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <span id="status" class="status"></span>
      <button id="clearBtn" type="button" class="danger">Clear</button>
      <button id="saveBtn" type="button" class="secondary" disabled>Save and continue</button>
      <button id="publishBtn" type="button" disabled>Publish DEBUG PDF (all inputs)</button>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    const fields = [
      "playerName","playerNumber","partnerName","partnerNumber",
      "biddingDescription","ntStrength","ntStrengthArtificial",
      "ntShape","ntShapeArtificial","nt2c","nt2d","nt2h","nt2s",
      "nt2nt","ntOthers","afterDouble","afterInterference",
      "twoCMeaning","twoCResponses","twoCNotes",
      "twoDMeaning","twoDResponses","twoDNotes",
      "twoHMeaning","twoHResponses","twoHNotes",
      "twoSMeaning","twoSResponses","twoSNotes",
      "twoNTMeaning","twoNTResponses","twoNTNotes",
      "otherAspects"
    ];

    const statusEl = $("status");
    const saveBtn = $("saveBtn");
    const publishBtn = $("publishBtn");
    const clearBtn = $("clearBtn");

    const COOKIE_NAME = "ebuSystemCardPage1_debug";

    // ---- cookie helpers ----
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const d = new Date();
        d.setTime(d.getTime() + days*24*60*60*1000);
        expires = "; expires=" + d.toUTCString();
      }
      document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(";");
      for (let c of ca) {
        c = c.trim();
        if (c.indexOf(nameEQ) === 0) {
          return decodeURIComponent(c.substring(nameEQ.length));
        }
      }
      return null;
    }

    function eraseCookie(name) {
      document.cookie = name + "=; Max-Age=-1; path=/";
    }

    // ---- direct data mapping ----
    function getData() {
      const data = {};
      fields.forEach(f => {
        const el = $(f);
        data[f] = el ? el.value : "";
      });
      return data;
    }

    function setData(data) {
      fields.forEach(f => {
        if (data[f] !== undefined && data[f] !== null) {
          const el = $(f);
          if (el) el.value = data[f];
        }
      });
      validateRequired();
    }

    function validateRequired() {
      const d = getData();
      const ok = d.playerName.trim() &&
                 d.playerNumber.trim() &&
                 d.partnerName.trim() &&
                 d.partnerNumber.trim() &&
                 d.biddingDescription.trim();
      saveBtn.disabled = !ok;
      publishBtn.disabled = !ok;
    }

    // attach change handlers
    fields.forEach(f => {
      const el = $(f);
      if (!el) return;
      el.addEventListener("input", () => {
        validateRequired();
        statusEl.textContent = "";
      });
    });

    // restore from cookie
    (function restoreFromCookie() {
      try {
        const raw = getCookie(COOKIE_NAME);
        if (!raw) {
          validateRequired();
          return;
        }
        const data = JSON.parse(raw);
        setData(data);
      } catch (e) {
        console.error("Failed to parse cookie data:", e);
      }
      validateRequired();
    })();

    // save
    saveBtn.addEventListener("click", () => {
      const data = getData();
      setCookie(COOKIE_NAME, JSON.stringify(data), 365);
      statusEl.textContent = "Saved in cookie (debug mode).";
      setTimeout(() => statusEl.textContent = "", 4000);
    });

    // clear
    clearBtn.addEventListener("click", () => {
      fields.forEach(f => {
        const el = $(f);
        if (el) el.value = "";
      });
      eraseCookie(COOKIE_NAME);
      validateRequired();
      statusEl.textContent = "All fields cleared and cookie removed.";
      setTimeout(() => statusEl.textContent = "", 4000);
    });

    // publish
    publishBtn.addEventListener("click", async () => {
      await generateDebugPdf(getData());
    });

    // ------------- DEBUG PDF: ALL FIELDS AS TEXT -------------
    async function generateDebugPdf(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 40;
      let x = margin;
      let y = margin;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("EBU System Card – DEBUG OUTPUT (all fields)", pageW / 2, y, { align: "center" });
      y += 24;

      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");

      const labels = {
        playerName: "Your name",
        playerNumber: "Your EBU number",
        partnerName: "Partner's name",
        partnerNumber: "Partner's EBU number",
        biddingDescription: "General description of bidding methods",
        ntStrength: "1NT strength",
        ntStrengthArtificial: "If artificial – details",
        ntShape: "Shape constraints",
        ntShapeArtificial: "If may have singleton – details",
        nt2c: "2♣ meaning",
        nt2d: "2♦ meaning",
        nt2h: "2♥ meaning",
        nt2s: "2♠ meaning",
        nt2nt: "2NT meaning",
        ntOthers: "Other 1NT responses",
        afterDouble: "Action after opponents double",
        afterInterference: "Action after other interference",
        twoCMeaning: "2♣ – meaning",
        twoCResponses: "2♣ – responses",
        twoCNotes: "2♣ – notes",
        twoDMeaning: "2♦ – meaning",
        twoDResponses: "2♦ – responses",
        twoDNotes: "2♦ – notes",
        twoHMeaning: "2♥ – meaning",
        twoHResponses: "2♥ – responses",
        twoHNotes: "2♥ – notes",
        twoSMeaning: "2♠ – meaning",
        twoSResponses: "2♠ – responses",
        twoSNotes: "2♠ – notes",
        twoNTMeaning: "2NT – meaning",
        twoNTResponses: "2NT – responses",
        twoNTNotes: "2NT – notes",
        otherAspects: "Other aspects of system"
      };

      const maxWidth = pageW - 2 * margin;
      const lineHeight = 14;

      for (const key of fields) {
        const label = labels[key] || key;
        const value = (data[key] || "").replace(/\r\n/g, "\n");

        const combined = label + ": " + value;
        const lines = doc.splitTextToSize(combined, maxWidth);

        if (y + lines.length * lineHeight > pageH - margin) {
          doc.addPage();
          y = margin;
        }

        doc.text(lines, x, y);
        y += lines.length * lineHeight;
      }

      doc.save("ebu-system-card-debug.pdf");
    }
  </script>
</body>
</html>
