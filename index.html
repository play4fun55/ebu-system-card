<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EBU System Card ‚Äì Page 1 Builder V0.7.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 20px 24px 24px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 18px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }
    h3 {
      font-size: 1rem;
      margin-top: 14px;
      margin-bottom: 6px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px 24px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px 16px;
    }
    .field {
      display: flex;
      flex-direction: column;
      margin-top: 8px;
    }
    label {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.92rem;
    }
    input, textarea {
      font: inherit;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
      margin-top: 2px;
    }
    .actions {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font: inherit;
      cursor: pointer;
      background: #1e88e5;
      color: white;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
      box-shadow: none;
    }
    button.danger {
      background: #e53935;
      color: #fff;
      box-shadow: none;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .status {
      font-size: 0.85rem;
      color: #388e3c;
      min-height: 1.2em;
    }
    @media (max-width: 800px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>EBU System Card ‚Äì Page 1 Builder V0.7.3</h1>

    <!-- HEADER -->
    <h2>Header</h2>
    <div class="grid-2">
      <div class="field">
        <label for="playerName">Your name</label>
        <input id="playerName" type="text" placeholder="Your full name" />
      </div>
      <div class="field">
        <label for="playerNumber">Your EBU number</label>
        <input id="playerNumber" type="text" placeholder="e.g. 491316" />
      </div>
      <div class="field">
        <label for="partnerName">Partner's name</label>
        <input id="partnerName" type="text" placeholder="Partner's full name" />
      </div>
      <div class="field">
        <label for="partnerNumber">Partner's EBU number</label>
        <input id="partnerNumber" type="text" placeholder="e.g. 525143" />
      </div>
    </div>

    <div class="field">
      <label for="biddingDescription">General description of bidding methods</label>
      <textarea id="biddingDescription" placeholder="e.g. 2 over 1 GF, 5M, 15‚Äì17 NT"></textarea>
    </div>

    <!-- 1NT OPENINGS -->
    <h2>1NT Openings and Responses</h2>

    <div class="grid-2">
      <div class="field">
        <label for="ntStrength">1NT strength</label>
        <input id="ntStrength" type="text" placeholder="e.g. 15‚Äì17" />
      </div>
      <div class="field">
        <label for="ntStrengthArtificial">If artificial ‚Äì details</label>
        <textarea id="ntStrengthArtificial"></textarea>
      </div>

      <div class="field">
        <label for="ntShape">Shape constraints</label>
        <textarea id="ntShape" placeholder="e.g. No singleton or void. No 6-card major or 7-card minor"></textarea>
      </div>
      <div class="field">
        <label for="ntShapeArtificial">If may have singleton ‚Äì details</label>
        <textarea id="ntShapeArtificial" placeholder="e.g. May contain singleton Ace or King"></textarea>
      </div>
    </div>

    <h3>Responses to 1NT</h3>
    <div class="grid-2">
      <div class="field">
        <label for="nt2c">2‚ô£ ‚Äì meaning</label>
        <textarea id="nt2c" placeholder="Stayman, may be weak, may take to minor"></textarea>
      </div>
      <div class="field">
        <label for="nt2d">2‚ô¶ ‚Äì meaning</label>
        <textarea id="nt2d" placeholder="Transfer to ‚ô• (break xx)"></textarea>
      </div>
      <div class="field">
        <label for="nt2h">2‚ô• ‚Äì meaning</label>
        <textarea id="nt2h" placeholder="Transfer to ‚ô† (break xx)"></textarea>
      </div>
      <div class="field">
        <label for="nt2s">2‚ô† ‚Äì meaning</label>
        <textarea id="nt2s" placeholder="Minor-suit Stayman: 2NT = 3‚Äì3, 3‚ô£/3‚ô¶ = longer minor"></textarea>
      </div>
      <div class="field">
        <label for="nt2nt">2NT ‚Äì meaning</label>
        <textarea id="nt2nt" placeholder="Transfer to ‚ô£"></textarea>
      </div>
      <div class="field">
        <label for="ntOthers">Other 1NT responses</label>
        <textarea id="ntOthers" placeholder="e.g. 3‚ô£ ‚Äì transfer to ‚ô¶; 3‚ô¶ = 4-4-4-1 with a major; etc."></textarea>
      </div>
    </div>

    <div class="grid-2">
      <div class="field">
        <label for="afterDouble">Action after opponents double</label>
        <textarea id="afterDouble" placeholder="e.g. Redouble = to play; all two-level bids are transfers (escape system)"></textarea>
      </div>
      <div class="field">
        <label for="afterInterference">Action after other interference</label>
        <textarea id="afterInterference" placeholder="e.g. Lebensohl; double shows values; etc."></textarea>
      </div>
    </div>

    <!-- TWO-LEVEL OPENINGS -->
    <h2>Two-level openings and responses</h2>

    <div class="field small">‚ÄúNotes‚Äù column on page 1 shows a note number; the actual text appears on page 4.</div>

    <h3>2‚ô£</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoCMeaning">Meaning</label>
        <textarea id="twoCMeaning" placeholder="Meaning of 2C"></textarea>
      </div>
      <div class="field">
        <label for="twoCResponses">Responses</label>
        <textarea id="twoCResponses" placeholder="Responses to 2C"></textarea>
      </div>
      <div class="field">
        <label for="twoCNotes">Note text (note 1)</label>
        <textarea id="twoCNotes"></textarea>
      </div>
    </div>

    <h3>2‚ô¶</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoDMeaning">Meaning</label>
        <textarea id="twoDMeaning" placeholder="Meaning of 2D"></textarea>
      </div>
      <div class="field">
        <label for="twoDResponses">Responses</label>
        <textarea id="twoDResponses" placeholder="Responses to 2D"></textarea>
      </div>
      <div class="field">
        <label for="twoDNotes">Note text (note 2)</label>
        <textarea id="twoDNotes"></textarea>
      </div>
    </div>

    <h3>2‚ô•</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoHMeaning">Meaning</label>
        <textarea id="twoHMeaning" placeholder="Meaning of 2H"></textarea>
      </div>
      <div class="field">
        <label for="twoHResponses">Responses</label>
        <textarea id="twoHResponses" placeholder="Responses to 2H"></textarea>
      </div>
      <div class="field">
        <label for="twoHNotes">Note text (note 3)</label>
        <textarea id="twoHNotes"></textarea>
      </div>
    </div>

    <h3>2‚ô†</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoSMeaning">Meaning</label>
        <textarea id="twoSMeaning" placeholder="Meaning of 2S"></textarea>
      </div>
      <div class="field">
        <label for="twoSResponses">Responses</label>
        <textarea id="twoSResponses" placeholder="Responses to 2S"></textarea>
      </div>
      <div class="field">
        <label for="twoSNotes">Note text (note 4)</label>
        <textarea id="twoSNotes"></textarea>
      </div>
    </div>

    <h3>2NT</h3>
    <div class="grid-3">
      <div class="field">
        <label for="twoNTMeaning">Meaning</label>
        <textarea id="twoNTMeaning" placeholder="Meaning of 2NT"></textarea>
      </div>
      <div class="field">
        <label for="twoNTResponses">Responses</label>
        <textarea id="twoNTResponses" placeholder="Responses to 2NT"></textarea>
      </div>
      <div class="field">
        <label for="twoNTNotes">Note text (note 5)</label>
        <textarea id="twoNTNotes"></textarea>
      </div>
    </div>

    <!-- OTHER ASPECTS -->
    <h2>Other aspects of system which opponents should note</h2>
    <div class="field">
      <textarea id="otherAspects" placeholder="Cue-bids, unusual 2NT, defensive conventions, etc."></textarea>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <span id="status" class="status"></span>
      <button id="clearBtn" type="button" class="danger">Clear</button>
      <button id="saveBtn" type="button" class="secondary" disabled>Save and continue</button>
      <button id="publishBtn" type="button" disabled>Publish PDF (4-page card layout)</button>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    const fields = [
      "playerName","playerNumber","partnerName","partnerNumber",
      "biddingDescription","ntStrength","ntStrengthArtificial",
      "ntShape","ntShapeArtificial","nt2c","nt2d","nt2h","nt2s",
      "nt2nt","ntOthers","afterDouble","afterInterference",
      "twoCMeaning","twoCResponses","twoCNotes",
      "twoDMeaning","twoDResponses","twoDNotes",
      "twoHMeaning","twoHResponses","twoHNotes",
      "twoSMeaning","twoSResponses","twoSNotes",
      "twoNTMeaning","twoNTResponses","twoNTNotes",
      "otherAspects"
    ];

    const statusEl = $("status");
    const saveBtn = $("saveBtn");
    const publishBtn = $("publishBtn");
    const clearBtn = $("clearBtn");

    const COOKIE_NAME = "ebuSystemCardPage1_full";

    // ---- cookie helpers ----
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const d = new Date();
        d.setTime(d.getTime() + days*24*60*60*1000);
        expires = "; expires=" + d.toUTCString();
      }
      document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(";");
      for (let c of ca) {
        c = c.trim();
        if (c.indexOf(nameEQ) === 0) {
          return decodeURIComponent(c.substring(nameEQ.length));
        }
      }
      return null;
    }

    function eraseCookie(name) {
      document.cookie = name + "=; Max-Age=-1; path=/";
    }

    // ---- direct data mapping ----
    function getData() {
      const data = {};
      fields.forEach(f => {
        const el = $(f);
        data[f] = el ? el.value : "";
      });
      return data;
    }

    function setData(data) {
      fields.forEach(f => {
        if (data[f] !== undefined && data[f] !== null) {
          const el = $(f);
          if (el) el.value = data[f];
        }
      });
      validateRequired();
    }

    function validateRequired() {
      const d = getData();
      const ok = d.playerName.trim() &&
                 d.playerNumber.trim() &&
                 d.partnerName.trim() &&
                 d.partnerNumber.trim() &&
                 d.biddingDescription.trim();
      saveBtn.disabled = !ok;
      publishBtn.disabled = !ok;
    }

    // attach listeners
    fields.forEach(f => {
      const el = $(f);
      if (!el) return;
      el.addEventListener("input", () => {
        validateRequired();
        statusEl.textContent = "";
      });
    });

    // restore from cookie
    (function restoreFromCookie() {
      try {
        const raw = getCookie(COOKIE_NAME);
        if (!raw) {
          validateRequired();
          return;
        }
        const data = JSON.parse(raw);
        setData(data);
      } catch (e) {
        console.error("Failed to parse cookie data:", e);
      }
      validateRequired();
    })();

    // save
    saveBtn.addEventListener("click", () => {
      const data = getData();
      setCookie(COOKIE_NAME, JSON.stringify(data), 365);
      statusEl.textContent = "Saved in cookie.";
      setTimeout(() => statusEl.textContent = "", 4000);
    });

    // clear
    clearBtn.addEventListener("click", () => {
      fields.forEach(f => {
        const el = $(f);
        if (el) el.value = "";
      });
      eraseCookie(COOKIE_NAME);
      validateRequired();
      statusEl.textContent = "All fields cleared and cookie removed.";
      setTimeout(() => statusEl.textContent = "", 4000);
    });

    // publish
    publishBtn.addEventListener("click", async () => {
      await generatePdf(getData());
    });

    // ---------- PDF LAYOUT HELPERS ----------
    function setFontRegular(doc, size) {
      doc.setFont("helvetica", "normal");
      doc.setFontSize(size);
    }
    function setFontBold(doc, size) {
      doc.setFont("helvetica", "bold");
      doc.setFontSize(size);
    }

    function drawFittedText(doc, text, x, y, w, h, baseSize, minSize, align = "left", bold = false) {
      const padding = 3;
      let size = baseSize;
      let lines = [text || ""];
      let lineHeight = size * 1.15;
      const maxWidth = w - 2 * padding;
      const maxHeight = h - 2 * padding;

      if (!text) return;

      while (size >= minSize) {
        if (bold) setFontBold(doc, size); else setFontRegular(doc, size);
        lineHeight = size * 1.15;
        lines = doc.splitTextToSize(text, maxWidth);
        const neededH = lines.length * lineHeight;
        if (neededH <= maxHeight) break;
        size -= 0.3;
      }

      if (bold) setFontBold(doc, size); else setFontRegular(doc, size);
      let curY = y + padding + size;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (align === "center") {
          const centerX = x + w / 2;
          doc.text(line, centerX, curY, { align: "center" });
        } else {
          doc.text(line, x + padding, curY);
        }
        curY += lineHeight;
        if (curY > y + h) break;
      }
    }

    function drawFrame(doc, x, y, w, h) {
      doc.setLineWidth(1.0);
      doc.rect(x, y, w, h);
    }

    function drawCenteredText(doc, text, x, y, size, bold = false) {
      if (bold) setFontBold(doc, size); else setFontRegular(doc, size);
      doc.text(text, x, y, { align: "center" });
    }

    function drawHeaderRow(doc, x, y, w, h, text, size = 9) {
      doc.setLineWidth(0.6);
      doc.rect(x, y, w, h);
      drawCenteredText(doc, text, x + w / 2, y + h / 2 + 3, size, true);
    }

   function drawLabelCell(doc, x, y, w, h, label, text) {
  doc.setLineWidth(0.4);
  doc.rect(x, y, w, h);

  // Reserve a fixed top area for the label (slightly larger)
  const labelHeight = 14;

  // --- LABEL TEXT ---
  setFontBold(doc, 8.2);
  const labelLines = doc.splitTextToSize(label || "", w - 6);
  const lh = 8.2 * 1.2;

  let curY = y + 5 + 8.2;             // higher placement
  const maxLabelY = y + labelHeight;

  labelLines.forEach(line => {
    if (curY <= maxLabelY) {
      doc.text(line, x + 3, curY);
      curY += lh;
    }
  });

  // --- BODY TEXT ---
  const bodyTop = y + labelHeight - 1;   // move text UP
  const bodyHeight = h - labelHeight - 2;

  if (text && bodyHeight > 0) {
    drawFittedText(
      doc,
      text,
      x + 3,           // padding
      bodyTop,
      w - 6,           // padding
      bodyHeight,
      10,              // üî• MAX FONT SIZE increased from 8 ‚Üí 10
      6.5,             // üî• MIN FONT SIZE increased from 5.5 ‚Üí 6.5
      "left",
      false
    );
  }
}

function drawActionRow(doc, x, y, labelW, bodyW, h, labelText, bodyText) {
  // Draw the two cells
  doc.setLineWidth(0.4);
  doc.rect(x, y, labelW, h);
  doc.rect(x + labelW, y, bodyW, h);

  // --- LABEL CELL ---
  setFontBold(doc, 8.2);
  const labelLines = doc.splitTextToSize(labelText || "", labelW - 6);
  const labelLH = 8.2 * 1.2;
  let curY = y + 5 + 8.2;          // a bit higher in the cell

  labelLines.forEach(line => {
    doc.text(line, x + 3, curY);
    curY += labelLH;
  });

  // --- BODY CELL ---
  // Use almost the full height, with bigger default font
  const bodyTop = y + 4;           // move text higher
  const bodyHeight = h - 8;

  if (bodyText && bodyHeight > 0) {
    drawFittedText(
      doc,
      bodyText,
      x + labelW + 3,              // left padding inside body cell
      bodyTop,
      bodyW - 6,                   // width inside body cell
      bodyHeight,
      9.5,                         // MAX font size (bigger)
      7.0,                         // MIN font size
      "left",
      false
    );
  }
}

    // ---------- PAGE DRAWING ----------

    async function generatePdf(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 24;
      const gap = 12;
      const panelW = (pageW - 2 * margin - gap) / 2;
      const panelH = pageH - 2 * margin;

      // Sheet 1: Page 4 (left) + Page 1 (right)
      drawPage4(doc, margin, margin, panelW, panelH, data);
      drawPage1(doc, margin + panelW + gap, margin, panelW, panelH, data);

      // Sheet 2: Page 2 (left) + Page 3 (right)
      doc.addPage();
      drawPage2(doc, margin, margin, panelW, panelH);
      drawPage3(doc, margin + panelW + gap, margin, panelW, panelH);

      doc.save("ebu-system-card.pdf");
    }

    function drawPage1(doc, x, y, w, h, d) {
      drawFrame(doc, x, y, w, h);

      const innerPad = 6;
      let cursorY = y + innerPad;

      // Header names
      const topH = 40;
      doc.setLineWidth(0.6);
      doc.rect(x + innerPad, cursorY, w - 2 * innerPad, topH);
      const leftX = x + innerPad + 6;
      const rightX = x + w - innerPad - 6;

      setFontBold(doc, 9.5);
      doc.text("Name", leftX, cursorY + 14);
      doc.text("Partner", leftX, cursorY + 30);

      setFontRegular(doc, 9);
      doc.text(d.playerName || "", leftX + 45, cursorY + 14);
      doc.text(d.partnerName || "", leftX + 45, cursorY + 30);

      setFontBold(doc, 9);
      doc.text("EBU No. " + (d.playerNumber || ""), rightX, cursorY + 14, { align: "right" });
      doc.text("EBU No. " + (d.partnerNumber || ""), rightX, cursorY + 30, { align: "right" });

      cursorY += topH + 4;

      // General description
      drawHeaderRow(doc, x + innerPad, cursorY, w - 2 * innerPad, 16,
        "GENERAL DESCRIPTION OF BIDDING METHODS", 9);
      cursorY += 16;

      const descH = 18;
      doc.setLineWidth(0.6);
      doc.rect(x + innerPad, cursorY, w - 2 * innerPad, descH);
      drawFittedText(doc, d.biddingDescription || "",
        x + innerPad, cursorY, w - 2 * innerPad, descH, 8.5, 6, "center", true);
      cursorY += descH + 3;

      // 1NT header
      drawHeaderRow(doc, x + innerPad, cursorY, w - 2 * innerPad, 16,
        "1NT OPENINGS AND RESPONSES", 9);
      cursorY += 16 + 1;

      // Strength & shape (2 columns)
      const rowH = 28;
      const twoColW = (w - 2 * innerPad) / 2;

      drawLabelCell(doc, x + innerPad, cursorY, twoColW, rowH,
        "Strength", d.ntStrength || "");
      drawLabelCell(doc, x + innerPad + twoColW, cursorY, twoColW, rowH,
        "If artificial ‚Äì details", d.ntStrengthArtificial || "");
      cursorY += rowH;

      drawLabelCell(doc, x + innerPad, cursorY, twoColW, rowH,
        "Shape constraints", d.ntShape || "");
      drawLabelCell(doc, x + innerPad + twoColW, cursorY, twoColW, rowH,
        "If may have singleton ‚Äì details", d.ntShapeArtificial || "");
      cursorY += rowH + 3;

      // Responses heading
      const respHeadH = 12;
      doc.setLineWidth(0.4);
      doc.rect(x + innerPad, cursorY, w - 2 * innerPad, respHeadH);
      setFontBold(doc, 8);
      doc.text("Responses", x + innerPad + 3, cursorY + 9);
      cursorY += respHeadH;

      // Responses rows
      const respRowH = 20;
      const halfW = (w - 2 * innerPad) / 2;

      function respRow(label1, text1, label2, text2) {
        doc.setLineWidth(0.4);
        doc.rect(x + innerPad, cursorY, halfW, respRowH);
        doc.rect(x + innerPad + halfW, cursorY, halfW, respRowH);

        const leftText = (label1 ? (label1 + ": ") : "") + (text1 || "");
        const rightText = (label2 ? (label2 + ": ") : "") + (text2 || "");

        drawFittedText(doc, leftText, x + innerPad, cursorY, halfW, respRowH, 8, 6, "left", false);
        drawFittedText(doc, rightText, x + innerPad + halfW, cursorY, halfW, respRowH, 8, 6, "left", false);

        cursorY += respRowH;
      }

      respRow("2C", d.nt2c, "2D", d.nt2d);
      respRow("2H", d.nt2h, "2S", d.nt2s);
      respRow("2NT", d.nt2nt, "Others", d.ntOthers);

      // Action rows
      const actH = 24;
      drawLabelCell(doc, x + innerPad, cursorY, 90, actH,
        "Action after opponents double", "");
      drawLabelCell(doc, x + innerPad + 90, cursorY,
        (w - 2 * innerPad) - 90, actH,
        "", d.afterDouble || "");
      cursorY += actH;

      drawLabelCell(doc, x + innerPad, cursorY, 90, actH,
        "Action after other interference", "");
      drawLabelCell(doc, x + innerPad + 90, cursorY,
        (w - 2 * innerPad) - 90, actH,
        "", d.afterInterference || "");
      cursorY += actH + 4;

      // Two-level openings
      drawHeaderRow(doc, x + innerPad, cursorY, w - 2 * innerPad, 16,
        "TWO-LEVEL OPENINGS AND RESPONSES", 9);
      cursorY += 16;

      const headerH = 14;
      const col1 = 32;
      const col2 = 165;
      const col3 = 165;
      const col4 = (w - 2 * innerPad) - (col1 + col2 + col3);

      doc.setLineWidth(0.4);
      doc.rect(x + innerPad, cursorY, w - 2 * innerPad, headerH);
      setFontBold(doc, 8);
      doc.text("Meaning", x + innerPad + col1 + 4, cursorY + 10);
      doc.text("Responses", x + innerPad + col1 + col2 + 4, cursorY + 10);
      doc.text("Notes", x + innerPad + col1 + col2 + col3 + 4, cursorY + 10);
      cursorY += headerH;

      function openingRow(label, m, r, noteText, noteIndex) {
        const rowH = 24;
        doc.rect(x + innerPad, cursorY, col1, rowH);
        doc.rect(x + innerPad + col1, cursorY, col2, rowH);
        doc.rect(x + innerPad + col1 + col2, cursorY, col3, rowH);
        doc.rect(x + innerPad + col1 + col2 + col3, cursorY, col4, rowH);

        setFontBold(doc, 9);
        doc.text(label, x + innerPad + 4, cursorY + 14);

        drawFittedText(doc, m || "", x + innerPad + col1, cursorY, col2, rowH, 7, 5.5, "left", false);
        drawFittedText(doc, r || "", x + innerPad + col1 + col2, cursorY, col3, rowH, 7, 5.5, "left", false);

        const noteLabel = (noteText && noteText.length > 0) ? String(noteIndex) : "";
        if (noteLabel) {
          drawFittedText(doc, noteLabel, x + innerPad + col1 + col2 + col3, cursorY, col4, rowH, 8, 6, "left", true);
        }

        cursorY += rowH;
      }

      openingRow("2C", d.twoCMeaning, d.twoCResponses, d.twoCNotes, 1);
      openingRow("2D", d.twoDMeaning, d.twoDResponses, d.twoDNotes, 2);
      openingRow("2H", d.twoHMeaning, d.twoHResponses, d.twoHNotes, 3);
      openingRow("2S", d.twoSMeaning, d.twoSResponses, d.twoSNotes, 4);
      openingRow("2NT", d.twoNTMeaning, d.twoNTResponses, d.twoNTNotes, 5);

      cursorY += 3;

      // Other aspects
      drawHeaderRow(doc, x + innerPad, cursorY, w - 2 * innerPad, 18,
        "OTHER ASPECTS OF SYSTEM WHICH OPPONENTS SHOULD NOTE", 9);
      cursorY += 18;

      const restH = y + h - cursorY - innerPad;
      doc.setLineWidth(0.4);
      doc.rect(x + innerPad, cursorY, w - 2 * innerPad, restH);

      drawFittedText(doc, d.otherAspects || "",
        x + innerPad, cursorY, w - 2 * innerPad, restH, 7.5, 5.5, "left", false);
    }

    function drawPage2(doc, x, y, w, h) {
      drawFrame(doc, x, y, w, h);
      drawCenteredText(doc, "PAGE 2 ‚Äì to be defined", x + w / 2, y + h / 2, 12, true);
    }

    function drawPage3(doc, x, y, w, h) {
      drawFrame(doc, x, y, w, h);
      drawCenteredText(doc, "PAGE 3 ‚Äì to be defined", x + w / 2, y + h / 2, 12, true);
    }

    function drawPage4(doc, x, y, w, h, d) {
      drawFrame(doc, x, y, w, h);
      const innerPad = 8;
      const headerH = 24;

      const notesData = [
        { n: 1, text: d.twoCNotes },
        { n: 2, text: d.twoDNotes },
        { n: 3, text: d.twoHNotes },
        { n: 4, text: d.twoSNotes },
        { n: 5, text: d.twoNTNotes }
      ];

      const maxWidth = w - 2 * innerPad - 6;
      const lineHeight = 9;
      const gap = 4;

      const rendered = [];
      notesData.forEach(note => {
        if (!note.text || note.text.trim().length === 0) return;
        const prefix = note.n + ". ";
        const lines = doc.splitTextToSize(prefix + note.text, maxWidth);
        rendered.push({ lines });
      });

      if (rendered.length === 0) {
        const headerTop = y + h * 0.75;
        const headerX = x + innerPad;
        drawHeaderRow(doc, headerX, headerTop,
          w - 2 * innerPad, headerH,
          "SYSTEM NOTES (from page 1)", 10);
        setFontRegular(doc, 8);
        doc.text("No notes defined yet.",
          headerX + 3,
          headerTop + headerH + 14);
        return;
      }

      let totalHeight = 0;
      rendered.forEach(r => {
        totalHeight += r.lines.length * lineHeight + gap;
      });

      let headerTop = y + h * 0.75;
      const minHeaderTop = y + innerPad;
      const maxHeaderTop = y + h - innerPad - headerH - 40;
      if (headerTop < minHeaderTop) headerTop = minHeaderTop;
      if (headerTop > maxHeaderTop) headerTop = maxHeaderTop;

      const headerX = x + innerPad;
      drawHeaderRow(doc, headerX, headerTop,
        w - 2 * innerPad, headerH,
        "SYSTEM NOTES (from page 1)", 10);

      const notesStartY = headerTop + headerH + 6;
      const availableH = y + h - innerPad - notesStartY;

      if (totalHeight <= availableH) {
        setFontRegular(doc, 7.5);
        let cursorY = notesStartY + 7.5;
        rendered.forEach(r => {
          doc.text(r.lines, headerX + 3, cursorY);
          cursorY += r.lines.length * lineHeight + gap;
        });
      } else {
        setFontRegular(doc, 7.5);
        doc.text(
          "System notes are printed on a separate sheet.",
          headerX + 3,
          notesStartY + 10
        );

        // extra portrait page with notes
        doc.addPage("a4", "portrait");
        const pw = doc.internal.pageSize.getWidth();
        const ph = doc.internal.pageSize.getHeight();
        const pm = 40;
        const contentW = pw - 2 * pm;

        drawHeaderRow(doc, pm, pm, contentW, 30, "SYSTEM NOTES (from page 1)", 12);

        setFontRegular(doc, 10);
        let cursorY = pm + 30 + 16;
        const portraitLineHeight = 12;
        rendered.forEach(r => {
          r.lines.forEach(line => {
            if (cursorY > ph - pm) {
              doc.addPage("a4", "portrait");
              cursorY = pm;
            }
            doc.text(line, pm + 4, cursorY);
            cursorY += portraitLineHeight;
          });
          cursorY += 6;
        });
      }
    }
  </script>
</body>
</html>
